# 要件定義書

**プロジェクト名**: Bouncing Balls ハイパフォーマンスシミュレーション  
**バージョン**: 2.0  
**作成日**: 2025-12-02  
**最終更新**: 2025-12-02

---

## 1. プロジェクト概要

### 1.1 目的

3つの異なる技術スタック（WebGPU、WASM、Pure JavaScript）を用いて、100万個規模のボールシミュレーションを実現し、各技術のパフォーマンス特性を可視化・比較する教育的デモンストレーションを提供する。

### 1.2 スコープ

- **対象**: Webブラウザ環境
- **規模**: 最大100万個のボール
- **バックエンド**: WebGPU、WASM (Rust)、Pure JavaScript
- **互換性**: WebGPU対応ブラウザ（Chrome/Edge 113+）、非対応ブラウザではWASM/Pure JSにフォールバック

---

## 2. 機能要件

### 2.1 物理シミュレーション

#### FR-001: ボールの跳ね返り
- **説明**: ボールは画面の4辺（上下左右）で跳ね返る
- **詳細**:
  - 壁との衝突時、速度ベクトルの該当成分を反転
  - 壁にめり込まないよう、位置を補正
- **優先度**: 高

#### FR-002: ボールの分裂
- **説明**: 壁との衝突時、ボールが2つに分裂する
- **詳細**:
  - 分裂後のサイズ: 元のサイズ × 0.8
  - 分裂後の速度: 元の速度 × (0.8 ~ 1.2のランダム値)
  - 分裂方向: 衝突軸に応じてランダムな速度成分を追加
  - 分裂後の色: ランダムに生成
- **優先度**: 高

#### FR-003: 分裂制限
- **説明**: ボール数が最大値（100万個）に達したら、それ以上分裂しない
- **詳細**:
  - アトミック操作（WebGPU）またはカウンタチェック（WASM/JS）で制御
  - 最小サイズ（1ピクセル）未満には分裂しない
- **優先度**: 高

#### FR-004: 分裂フラグ管理
- **説明**: 1回の衝突で複数回分裂しないよう、`just_split`フラグで制御
- **詳細**:
  - 分裂直後はフラグをON
  - 次のフレームでフラグをOFF
- **優先度**: 中

### 2.2 バックエンド機能

#### FR-005: WebGPUバックエンド
- **説明**: GPU Compute Shaderで物理演算、GPU Render Pipelineで描画
- **詳細**:
  - Compute Shader: WGSL、64スレッド/ワークグループ
  - Render Pipeline: インスタンス描画、円形シェーダー
  - データ型: f32（位置、速度、半径）、u32（色、フラグ、カウント）
- **優先度**: 高

#### FR-006: WASMバックエンド
- **説明**: Rustで物理演算、ImageDataピクセルバッファで描画
- **詳細**:
  - Rust: release最適化ビルド
  - 描画: RGBA形式のピクセルバッファに直接描画
  - 転送: `putImageData()`で一括転送
- **優先度**: 高

#### FR-007: Pure JavaScriptバックエンド
- **説明**: JavaScriptで物理演算、Canvas 2D APIで描画
- **詳細**:
  - 物理演算: 配列ベースの状態管理
  - 描画: 色グループ化によるfillStyle変更削減
- **優先度**: 中

### 2.3 UI機能

#### FR-008: バックエンド切り替え
- **説明**: 実行中にWebGPU/WASM/Pure JSを切り替え可能
- **詳細**:
  - ボタンクリックで即座に切り替え
  - Canvas要素を再作成（WebGPU/2Dコンテキスト競合回避）
  - シミュレーションをリセット（1個のボールから再開）
- **優先度**: 高

#### FR-009: FPS制限切り替え
- **説明**: 60FPS/120FPSを選択可能
- **詳細**:
  - `requestAnimationFrame`のdeltaTimeで制御
  - ボタンの色で現在の設定を表示（緑=有効、グレー=無効）
- **優先度**: 中

#### FR-010: パフォーマンス表示
- **説明**: リアルタイムでパフォーマンス指標を表示
- **詳細**:
  - FPS: 実際のフレームレート
  - Frame Time: フレーム間隔（ms）
  - Update: 物理演算時間（ms）
  - Render: 描画時間（ms）
  - Ball Count: 現在のボール数
- **優先度**: 高

---

## 3. 非機能要件

### 3.1 パフォーマンス

#### NFR-001: WebGPU性能
- **要件**: 100万個のボールで60FPS維持
- **測定方法**: Frame Timeが16.67ms以下
- **優先度**: 高

#### NFR-002: WASM性能
- **要件**: 100万個のボールで10-20FPS
- **測定方法**: Frame Timeが50-100ms
- **優先度**: 中

#### NFR-003: Pure JS性能
- **要件**: 100万個のボールで3-4FPS（ベースライン）
- **測定方法**: Frame Timeが250-350ms
- **優先度**: 低

#### NFR-004: 起動時間
- **要件**: 初期化完了まで3秒以内
- **測定方法**: ページロードから最初のフレーム描画まで
- **優先度**: 中

### 3.2 互換性

#### NFR-005: ブラウザ対応
- **要件**:
  - WebGPU: Chrome/Edge 113+
  - WASM: Chrome/Edge/Firefox/Safari（最新版）
  - Pure JS: すべてのモダンブラウザ
- **フォールバック**: WebGPU非対応時、自動的にWASMへ
- **優先度**: 高

#### NFR-006: 画面サイズ対応
- **要件**: ウィンドウリサイズに対応
- **詳細**: Canvas要素を自動的にリサイズ
- **優先度**: 中

### 3.3 保守性

#### NFR-007: コードの分離
- **要件**: ロジック（物理演算）と描画を完全分離
- **詳細**: 各バックエンドが共通インターフェースを実装
- **優先度**: 高

#### NFR-008: ドキュメント
- **要件**: 包括的なドキュメントを提供
- **詳細**: README、要件定義書、設計書、API仕様書
- **優先度**: 中

---

## 4. UI/UX要件

### 4.1 レイアウト

#### UX-001: 全画面Canvas
- **説明**: Canvasが画面全体を占める
- **詳細**: マージン・パディングなし、オーバーフロー非表示
- **優先度**: 高

#### UX-002: オーバーレイUI
- **説明**: 左上にパフォーマンス情報とボタンを表示
- **詳細**:
  - 半透明背景（rgba(0, 0, 0, 0.7)）
  - ボタンのみクリック可能（pointer-events: auto）
- **優先度**: 高

### 4.2 視覚的フィードバック

#### UX-003: バックエンド表示
- **説明**: 現在のバックエンドを色分けして表示
- **詳細**:
  - WebGPU: 緑色
  - WASM: オレンジ色
  - Pure JS: 青色
- **優先度**: 中

#### UX-004: FPS制限表示
- **説明**: 現在のFPS制限をボタンの色で表示
- **詳細**:
  - 有効: 緑色
  - 無効: グレー
- **優先度**: 低

### 4.3 応答性

#### UX-005: 即座の切り替え
- **説明**: バックエンド/FPS切り替えが即座に反映される
- **詳細**: ボタンクリックから1秒以内に切り替え完了
- **優先度**: 高

---

## 5. 制約事項

### 5.1 技術的制約

- **WebGPU**: Chrome/Edge 113+のみ対応
- **WASM**: Rustツールチェーン、wasm-packが必要
- **メモリ**: 100万個のボールで約200MB（WebGPU/WASM）

### 5.2 運用制約

- **開発サーバー**: ローカルHTTPサーバーが必要（file://では動作しない）
- **ビルド**: WASMビルドに数秒かかる

---

## 6. 将来の拡張

### 6.1 検討中の機能

- ボール間の衝突判定
- 重力・摩擦の追加
- ユーザー操作（マウスでボールを追加）
- パフォーマンスグラフの表示

### 6.2 非対応機能

- ネットワーク同期（マルチプレイヤー）
- 永続化（状態の保存/読み込み）

---

## 7. 承認

| 役割 | 氏名 | 日付 | 署名 |
|------|------|------|------|
| プロジェクトオーナー | Tane Channel Technology | 2025-12-02 | - |
| 技術リード | Antigravity AI | 2025-12-02 | - |

---

**変更履歴**:

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0 | 2025-11-XX | 初版（2000個、WASMのみ） |
| 2.0 | 2025-12-02 | 100万個対応、マルチバックエンド、パフォーマンス測定機能追加 |
